stages:
  - release
  - publish_github

variables:
  # Ensure git has enough history to compare changes
  GIT_DEPTH: "2"

package_and_publish:
  stage: release
  image: dtzar/helm-kubectl:latest  # Image that includes Helm, Git and Curl
  before_script:
    - apk add --no-cache curl git
  tags:
    - doks
  script:
    - |
      echo "Starting Helm Charts publishing process..."
      
      # Detect files changed in the last commit (HEAD~1 to HEAD)
      CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
      
      # Iterate over each directory in the root
      for dir in */; do
        # Remove trailing slash from directory name (e.g.: "sd-core/" -> "sd-core")
        dir=${dir%*/}
        
        # Check if it's a Helm directory (has Chart.yaml) and has your VERSION file
        if [ -f "$dir/Chart.yaml" ] && [ -f "$dir/VERSION" ]; then
          
          # Check if this directory had changes
          if echo "$CHANGED_FILES" | grep -q "^$dir/"; then
            
            # Read version from first line
            VERSION=$(cat $dir/VERSION | sed -n '1p')
            
            # Read environment from second line (dev or prod)
            ENVIRONMENT=$(cat $dir/VERSION | sed -n '2p')
            
            # Set channel based on environment
            if [ "$ENVIRONMENT" = "prod" ]; then
              CHANNEL="stable"
            else
              CHANNEL="dev"
            fi
            
            # Build Helm repository URL with the appropriate channel
            HELM_REPO_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/api/${CHANNEL}/charts"
            
            CHART_NAME=$(grep '^name:' $dir/Chart.yaml | awk '{print $2}')
            
            echo "--------------------------------------------------"
            echo "Change detected in: $dir"
            echo "Chart: $CHART_NAME | Target version: $VERSION"
            echo "Environment: $ENVIRONMENT | Channel: $CHANNEL"
            
            # KEY STEP: Update the version in Chart.yaml to match your VERSION file
            # This ensures the generated package has the correct version (x.x.x)
            sed -i "s/^version:.*/version: $VERSION/" $dir/Chart.yaml
            
            # Package the chart
            helm package $dir
            
            # Name of the file generated by helm package
            TGZ_NAME="${CHART_NAME}-${VERSION}.tgz"
            
            # Upload the package to GitLab registry
            echo "Uploading $TGZ_NAME to registry..."
            
            HTTP_STATUS=$(curl --request POST \
                 --form "chart=@${TGZ_NAME}" \
                 --user gitlab-ci-token:$CI_JOB_TOKEN \
                 --write-out "%{http_code}" \
                 --silent \
                 --output /dev/null \
                 "${HELM_REPO_URL}")

            if [ "$HTTP_STATUS" -eq 201 ]; then
              echo "✅ Success: Version $VERSION of $CHART_NAME published successfully."
            elif [ "$HTTP_STATUS" -eq 409 ]; then
              echo "⚠️ Warning: Version $VERSION of $CHART_NAME already exists in the registry. Nothing was uploaded."
            else
              echo "❌ Error: Upload failed with HTTP code $HTTP_STATUS."
              exit 1
            fi
            
          else
            echo "Skipping $dir (no changes detected)."
          fi
        fi
      done
  rules:
    - if: $CI_COMMIT_REF_NAME == "main" # Solo se ejecuta si es la rama 'main'

publish_to_github_packages:
  stage: publish_github
  image: dtzar/helm-kubectl:latest
  tags:
    - doks
  before_script:
    - apk add --no-cache curl git
  script:
    - |
      echo "Publishing Helm Charts to GitHub Packages..."
      
      # Detect files changed in the last commit (HEAD~1 to HEAD)
      CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
      
      # Iterate over each directory in the root
      for dir in */; do
        # Remove trailing slash from directory name
        dir=${dir%*/}
        
        # Check if it's a Helm directory (has Chart.yaml) and has VERSION file
        if [ -f "$dir/Chart.yaml" ] && [ -f "$dir/VERSION" ]; then
          
          # Check if this directory had changes
          if echo "$CHANGED_FILES" | grep -q "^$dir/"; then
            
            # Read version from first line
            VERSION=$(cat $dir/VERSION | sed -n '1p')
            
            # Read environment from second line (dev or prod)
            ENVIRONMENT=$(cat $dir/VERSION | sed -n '2p')
            
            CHART_NAME=$(grep '^name:' $dir/Chart.yaml | awk '{print $2}')
            
            echo "--------------------------------------------------"
            echo "Change detected in: $dir"
            echo "Chart: $CHART_NAME | Version: $VERSION"
            echo "Environment: $ENVIRONMENT"
            
            # Update version in Chart.yaml
            sed -i "s/^version:.*/version: $VERSION/" $dir/Chart.yaml
            
            # Package the chart
            helm package $dir
            
            # Name of the file generated by helm package
            TGZ_NAME="${CHART_NAME}-${VERSION}.tgz"
            
            # Upload to GitHub Packages
            echo "Uploading $TGZ_NAME to GitHub Packages..."
            
            HTTP_STATUS=$(curl --request POST \
                 --form "chart=@${TGZ_NAME}" \
                 --user "${GITHUB_USERNAME}:${GITHUB_BOT_TOKEN}" \
                 --write-out "%{http_code}" \
                 --silent \
                 --output /dev/null \
                 "https://ghcr.io/v2/${GITHUB_ORG}/charts/${CHART_NAME}/blobs/uploads/")

            if [ "$HTTP_STATUS" -eq 201 ] || [ "$HTTP_STATUS" -eq 202 ]; then
              echo "✅ Success: Version $VERSION of $CHART_NAME published to GitHub Packages."
            else
              echo "⚠️ Attempting alternative upload method..."
              
              # Alternative: Use helm push with OCI registry
              echo "${GITHUB_BOT_TOKEN}" | helm registry login ghcr.io -u ${GITHUB_USERNAME} --password-stdin
              
              helm push ${TGZ_NAME} oci://ghcr.io/${GITHUB_ORG}/charts
              
              if [ $? -eq 0 ]; then
                echo "✅ Success: Version $VERSION of $CHART_NAME published to GitHub Packages via OCI."
              else
                echo "❌ Error: Failed to upload to GitHub Packages."
                exit 1
              fi
            fi
            
          else
            echo "Skipping $dir (no changes detected)."
          fi
        fi
      done
  rules:
    - if: $CI_COMMIT_REF_NAME == "main" # Solo se ejecuta si es la rama 'main'
