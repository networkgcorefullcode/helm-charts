stages:
  - release
  - publish_github

variables:
  GIT_DEPTH: "2"
  # Valores por defecto (pueden ser sobrescritos por variables de CI/CD)
  GITHUB_ORG: "networkgcorefullcode"  # ‚¨ÖÔ∏è Cambia esto por tu organizaci√≥n

package_and_publish:
  stage: release
  image: dtzar/helm-kubectl:latest
  before_script:
    - apk add --no-cache curl git
    # Verificar variables requeridas
    - |
      if [ -z "$GITHUB_USERNAME" ]; then
        echo "‚ùå ERROR: Debes configurar GITHUB_USERNAME en GitLab CI/CD Variables"
        exit 1
      fi
    - |
      if [ -z "$GITHUB_BOT_TOKEN" ]; then
        echo "‚ùå ERROR: Debes configurar GITHUB_BOT_TOKEN en GitLab CI/CD Variables"
        exit 1
      fi
    - echo "‚úÖ Variables configuradas correctamente"
  tags:
    - doks
  script:
    - |
      for dir in */; do
        dir=${dir%*/}          
        CHART_VERSION=$(grep '^version:' $dir/Chart.yaml | awk '{print $2}')
        CHART_NAME=$(grep '^name:' $dir/Chart.yaml | awk '{print $2}')
        
        # Agregar sufijo seg√∫n la rama
        if [ "$CI_COMMIT_REF_NAME" = "operator" ]; then
          TGZ_NAME="${CHART_NAME}-${CHART_VERSION}-operator.tgz"
        else
          TGZ_NAME="${CHART_NAME}-${CHART_VERSION}.tgz"
        fi
        
        HELM_REPO_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/api/stable/charts"

        helm package $dir --version ${CHART_VERSION} -d .

        if [ "$CI_COMMIT_REF_NAME" = "operator" ]; then
          mv "${CHART_NAME}-${CHART_VERSION}.tgz" "${TGZ_NAME}"
        fi

        curl --request POST \
          --form "chart=@${TGZ_NAME}" \
          --user gitlab-ci-token:$CI_JOB_TOKEN \
          --write-out "%{http_code}" \
          --silent \
          --output /dev/null \
          "${HELM_REPO_URL}"
      done
      
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"
      when: always
    - if: $CI_COMMIT_REF_NAME == "operator"
      when: always

publish_to_github_packages:
  stage: publish_github
  image: dtzar/helm-kubectl:latest
  tags:
    - doks
  before_script:
    - apk add --no-cache curl git
    # Verificar variables requeridas
    - |
      if [ -z "$GITHUB_USERNAME" ] || [ -z "$GITHUB_BOT_TOKEN" ]; then
        echo "‚ùå ERROR: Configura GITHUB_USERNAME y GITHUB_BOT_TOKEN en GitLab"
        exit 1
      fi
    - echo "üöÄ Publicando a ghcr.io/${GITHUB_ORG}"
  script:
    - |      
      for dir in */; do
        dir=${dir%*/}        
        CHART_VERSION=$(grep '^version:' $dir/Chart.yaml | awk '{print $2}')
        CHART_NAME=$(grep '^name:' $dir/Chart.yaml | awk '{print $2}')
        
        if [ "$CI_COMMIT_REF_NAME" = "operator" ]; then
          CHART_TAG="${CHART_VERSION}-operator"
          TGZ_NAME="${CHART_NAME}-${CHART_VERSION}-operator.tgz"
        else
          CHART_TAG="${CHART_VERSION}"
          TGZ_NAME="${CHART_NAME}-${CHART_VERSION}.tgz"
        fi
        
        echo "üì¶ Empaquetando: $CHART_NAME versi√≥n $CHART_TAG"
        helm registry login ghcr.io -u $GITHUB_USERNAME -p $GITHUB_BOT_TOKEN
        
        helm package $dir --version ${CHART_VERSION} -d .
        
        if [ "$CI_COMMIT_REF_NAME" = "operator" ]; then
          mv "${CHART_NAME}-${CHART_VERSION}.tgz" "${TGZ_NAME}"
        fi
        
        echo "‚¨ÜÔ∏è  Subiendo a: ghcr.io/${GITHUB_ORG}/${CHART_NAME}:${CHART_TAG}"
        helm push ${TGZ_NAME} oci://ghcr.io/${GITHUB_ORG}
        
        echo "‚úÖ Completado: ${CHART_NAME}:${CHART_TAG}"
      done
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"
      when: always
    - if: $CI_COMMIT_REF_NAME == "operator"
      when: always