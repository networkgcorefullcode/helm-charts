name: Publish Helm Charts to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-branch
          fetch-depth: 0

      - name: Build and Package Helm Charts
        run: |
          echo "Building Helm Charts..."
          
          # Create output directory for packages
          mkdir -p packaged-charts
          
          # Copy existing .tgz files from gh-pages to preserve history
          if [ -d "gh-pages-branch" ]; then
            echo "Copying existing .tgz files from gh-pages..."
            find gh-pages-branch -name "*.tgz" -exec cp {} packaged-charts/ \; 2>/dev/null || true
            
            # Copy existing index.yaml to merge with new charts
            if [ -f "gh-pages-branch/index.yaml" ]; then
              cp gh-pages-branch/index.yaml packaged-charts/index.yaml
              echo "Existing index.yaml copied for merging"
            fi
          fi
          
          # Iterate over each directory in the root
          for dir in */; do
            # Remove trailing slash from directory name
            dir=${dir%*/}
            
            # Skip gh-pages-branch directory
            if [ "$dir" = "gh-pages-branch" ]; then
              continue
            fi
            
            # Check if it's a Helm directory (has Chart.yaml)
            if [ -f "$dir/Chart.yaml" ]; then
              
              # Read version and name from Chart.yaml
              VERSION=$(grep '^version:' $dir/Chart.yaml | awk '{print $2}')
              CHART_NAME=$(grep '^name:' $dir/Chart.yaml | awk '{print $2}')
              
              echo "--------------------------------------------------"
              echo "Processing: $dir"
              echo "Chart: $CHART_NAME"
              echo "Version: $VERSION"
              
              # Package the chart
              for chart_dir in $dir/core-helm/*/; do
                if [ -d "$chart_dir" ]; then
                  echo "Updating dependencies for sub-chart: $chart_dir"
                  helm dependency update "$chart_dir"
                  helm dependency list "$chart_dir"
                  helm package "$chart_dir"
                fi
              done
              helm dependency update $dir
              helm dependency list $dir
              rm -rf $dir/core-helm/
              helm package $dir -d packaged-charts 
              
              echo "Packaged: ${CHART_NAME}-${VERSION}.tgz"
            fi
          done
          
          echo "--------------------------------------------------"
          echo "All packaged charts:"
          ls -lh packaged-charts/*.tgz

      - name: Generate Helm Repository Index
        run: |
          cd packaged-charts
          
          # Generate/update index.yaml with all .tgz files
          # The --merge flag will merge with existing index.yaml if it exists
          if [ -f "index.yaml" ]; then
            echo "Merging with existing index.yaml..."
            helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }} --merge index.yaml
          else
            echo "Generating new index.yaml..."
            helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          fi
          
          # Create index.html
          cat > index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>Helm Charts Repository</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  h1 { color: #333; }
                  pre { background: #f4f4f4; padding: 15px; border-radius: 5px; }
                  code { background: #e8e8e8; padding: 2px 6px; border-radius: 3px; }
                  .info { background: #e7f3fe; padding: 15px; border-left: 4px solid #2196F3; margin: 20px 0; }
              </style>
          </head>
          <body>
              <h1>Helm Charts Repository</h1>
              
              <div class="info">
                <strong>Repository URL:</strong> https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
              </div>
              
              <h2>Add this repository to Helm:</h2>
              <pre><code>helm repo add my-charts https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}</code></pre>
              
              <h2>Update your repositories:</h2>
              <pre><code>helm repo update</code></pre>
              
              <h2>Search for charts:</h2>
              <pre><code>helm search repo my-charts</code></pre>
              
              <h2>Install a chart:</h2>
              <pre><code>helm install my-release my-charts/[CHART-NAME]</code></pre>
              
              <h2>Available Resources:</h2>
              <ul>
                <li><a href="index.yaml">View index.yaml</a></li>
              </ul>
              
              <h2>Charts in this repository:</h2>
              <pre>$(ls -1 *.tgz 2>/dev/null | sort || echo "No charts available")</pre>
          </body>
          </html>
          EOF
          
          echo "--------------------------------------------------"
          echo "Repository index generated successfully"
          echo "Total charts in repository:"
          ls -1 *.tgz | wc -l

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./packaged-charts
          publish_branch: gh-pages
          force_orphan: false
          keep_files: false  # This ensures old files are not kept (we already copied what we need)
